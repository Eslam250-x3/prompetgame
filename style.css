/* style.css */
:root {
    --primary-color: #1a2a6c; /* أزرق داكن مهيب */
    --secondary-color: #8e2de2; /* بنفسجي حيوي - استخدمته سابقًا في اللعبة */
    --accent-color: #fdbb2d; /* أصفر ذهبي مشرق */
    --text-color: #f0f0f0; /* أبيض مائل للرمادي للقراءة المريحة */
    --bg-color: #0f0c29; /* خلفية فضاء/ليل داكنة جداً */
    --card-bg: #1c183f; /* خلفية كروت أفتح قليلاً من الخلفية الرئيسية */
    --success-color: #2ecc71; /* أخضر للنجاح */
    --warning-color: #f39c12; /* برتقالي للتحذير/التلميح */
    --danger-color: #e74c3c; /* أحمر للخطأ/الخروج */
    --font-family-arabic: 'Cairo', sans-serif; /* خط عربي عصري */
    --font-family-latin: 'Poppins', sans-serif; /* خط لاتيني مكمل */
    --border-radius: 12px; /* زوايا دائرية أنيقة */
    --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35); /* ظل أعمق وأكثر نعومة */
    --nav-width: 80px; /* عرض منطقة التنقل الجانبية الثابتة */
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-family-arabic);
    background-color: var(--bg-color);
    background: linear-gradient(135deg, var(--bg-color) 0%, #2a0845 70%, var(--secondary-color) 100%);
    color: var(--text-color);
    line-height: 1.7;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 70px; /* مساحة للتذييل */
    padding-right: calc(var(--nav-width) + 10px); /* مساحة لعناصر التحكم الجانبية + هامش */
}
html[dir="ltr"] body {
    padding-right: 10px;
    padding-left: calc(var(--nav-width) + 10px);
}

/* --- حاويات الصفحات الرئيسية --- */
.main-container, .presentation-container { /* .presentation-container يستخدم كـ gamePage */
    width: 100%; /* يأخذ العرض المتاح بعد الحشو في body */
    max-width: 1200px; /* حد أقصى لعرض اللعبة */
    min-height: 80vh; /* لضمان ارتفاع كافٍ دائمًا */
    display: flex;
    flex-direction: column;
    /* margin-top: 2vh; */ /* مسافة من الأعلى */
}

#loginPage, #leaderboardPage {
    background-color: var(--card-bg);
    padding: 30px 40px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    text-align: center;
    max-width: 650px; /* عرض مناسب لصفحات الدخول والليدربورد */
    margin: 5vh auto; /* توسيط وتوفير مسافة */
}

/* --- عناصر مشتركة --- */
header h1, .card-style-content h1 { /* لعنوان اللعبة في صفحة الدخول */
    color: var(--accent-color);
    text-align: center;
    margin-bottom: 10px;
    font-size: 2.8em;
    font-weight: 700;
    text-shadow: 0 0 15px rgba(253, 187, 45, 0.4);
}
.subtitle {
    text-align: center;
    color: #b0b0b0;
    font-size: 1.2em;
    margin-bottom: 30px;
}

.btn {
    padding: 12px 28px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-family: var(--font-family-arabic);
    font-size: 1.1em;
    font-weight: bold;
    transition: all 0.25s ease-in-out;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn i {
    font-size: 1em; /* حجم الأيقونة يتناسب مع الخط */
}

.btn-primary {
    background: linear-gradient(45deg, var(--accent-color), #f7b733);
    color: #2c1a0b; /* لون نص داكن ليتناسب مع الخلفية الصفراء */
    box-shadow: 0 4px 10px rgba(253, 187, 45, 0.3);
}
.btn-primary:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 7px 18px rgba(253, 187, 45, 0.45);
}

.btn-secondary {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--accent-color);
    border: 1px solid var(--accent-color);
}
.btn-secondary:hover {
    background-color: rgba(253, 187, 45, 0.2);
    color: #fff;
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}
.btn-danger:hover {
    background-color: #c82333;
}
.btn-warning {
    background-color: var(--warning-color);
    color: #333;
}
.btn-warning:hover {
    background-color: #e0a800;
}

.btn-small {
    padding: 8px 15px;
    font-size: 0.95em;
}

input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 2px solid #444;
    background-color: #2a2a2a;
    color: var(--text-color);
    font-family: var(--font-family-arabic);
    font-size: 1em;
    transition: border-color 0.3s;
}
input[type="text"]:focus {
    border-color: var(--accent-color);
    outline: none;
    box-shadow: 0 0 8px rgba(253, 187, 45, 0.3);
}

/* --- صفحة اللعبة (`gamePage`) --- */
#gamePage { /* هذه هي .presentation-container في ملف HTML */
    display: flex; /* للتحكم في الشريط الجانبي ومحتوى اللعبة الرئيسي */
    flex-direction: row; /* الافتراضي، يمكن تعديله إذا أردت الشريط الجانبي على اليسار */
    gap: 20px;
    padding: 0; /* الحشو سيكون داخل game-content-area */
    background: none; /* الخلفية تأتي من body */
    box-shadow: none;
    height: calc(100vh - 70px - 4vh); /* ارتفاع كامل مطروح منه التذييل ومسافة علوية */
    margin-top: 2vh;
}

.game-main-content {
    flex-grow: 1; /* اجعل منطقة اللعب الرئيسية تأخذ المساحة المتبقية */
    display: flex;
    flex-direction: column;
    height: 100%; /* لتمكين التمرير الداخلي */
}

.game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background-color: var(--card-bg);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    border-bottom: 3px solid var(--accent-color);
    box-shadow: var(--box-shadow);
}
.player-info span, .level-info h3 { margin: 0 10px; font-size: 1em; }
.player-info .value { color: var(--accent-color); font-weight: bold; }
.level-info h3 i { color: var(--accent-color); }

.game-content-area { /* هذا هو المكان الذي يعرض فيه التحدي */
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: var(--card-bg);
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    box-shadow: var(--box-shadow);
}
.game-content-area::-webkit-scrollbar { width: 8px; }
.game-content-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
.game-content-area::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }
.game-content-area::-webkit-scrollbar-thumb:hover { background: #e8a820; }

#challengeDisplay { /* هذا هو .card-style-content داخل .game-content-area */
    /* لا يحتاج لتغييرات كثيرة، التنسيقات العامة لـ .card-style-content تطبق */
}

#challengeDisplay h2 { /* عنوان التحدي */
    font-size: 1.7em;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}
#challengeDisplay h2 i { margin-left: 10px; }

.challenge-description {
    background-color: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    line-height: 1.8;
    font-size: 1.05em;
    border-left: 3px solid var(--secondary-color);
}
html[dir="ltr"] .challenge-description { border-left:none; border-right: 3px solid var(--secondary-color); }

textarea#promptInput {
    width: 100%;
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #444;
    background-color: #2c2c2c; /* أغمق قليلاً */
    color: var(--text-color);
    font-family: var(--font-family-arabic);
    font-size: 1.05em;
    margin-bottom: 15px;
    resize: vertical;
    min-height: 120px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}
.prompt-input-area { margin-top: 25px; }
.prompt-input-area label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--accent-color); font-size: 1.1em; }

.feedback {
    margin-top: 25px;
    padding: 18px;
    border-radius: 8px;
    border-width: 2px;
    border-style: solid;
    font-size: 1.05em;
    transition: all 0.3s ease;
}
.feedback h4 { margin-top: 0; margin-bottom: 10px; color: inherit; } /* يرث لون النص من الكلاس الأب */
.feedback.hidden { display: none; } /* للتأكد من الإخفاء */

.feedback.success { background-color: rgba(46, 204, 113, 0.1); border-color: var(--success-color); color: var(--success-color); }
.feedback.warning { background-color: rgba(243, 156, 18, 0.1); border-color: var(--warning-color); color: var(--warning-color); }
.feedback.error { background-color: rgba(231, 76, 60, 0.1); border-color: var(--danger-color); color: var(--danger-color); }


.mentor-speech {
    background-color: rgba(142, 45, 226, 0.15); /* --secondary-color with alpha */
    padding: 12px 18px;
    border-radius: 10px;
    margin-bottom: 20px;
    border-left: 4px solid var(--secondary-color);
    position: relative; /* للفقاعة */
    font-style: italic;
    color: #e0e0e0;
}
html[dir="ltr"] .mentor-speech { border-left:none; border-right: 4px solid var(--secondary-color); }

.mentor-speech.hidden { display:none; }
.mentor-speech::before { /* شكل الفقاعة */
    content: '';
    position: absolute;
    right: 100%; 
    top: 15px;
    border-width: 10px;
    border-style: solid;
    border-color: transparent rgba(142, 45, 226, 0.15) transparent transparent;
}
html[dir="ltr"] .mentor-speech::before {
    right: auto;
    left: 100%;
    border-color: transparent transparent transparent rgba(142, 45, 226, 0.15);
}


/* --- الشريط الجانبي لمعلومات اللعبة (جديد) --- */
.sidebar-game-info {
    width: 250px; /* عرض ثابت للشريط الجانبي */
    flex-shrink: 0; /* امنعه من الانكماش */
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    height: 100%; /* اجعله يملأ ارتفاع حاوية اللعبة */
    overflow-y: auto;
    border-left: 3px solid var(--accent-color); /* تمييز جانبي */
}
html[dir="ltr"] .sidebar-game-info { border-left:none; border-right: 3px solid var(--accent-color); }

.sidebar-game-info h4 {
    color: var(--accent-color);
    margin-top: 0;
    margin-bottom: 12px;
    border-bottom: 1px solid rgba(var(--accent-color-rgb, 253, 187, 45), 0.3);
    padding-bottom: 8px;
    font-size: 1.15em;
}
.sidebar-game-info h4 i { margin-left: 8px;}

.badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}
.badge {
    width: 48px; height: 48px;
    background: linear-gradient(145deg, var(--accent-color), #e8a820);
    color: #332a10;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4em; /* حجم أيقونة الشارة */
    box-shadow: 0 3px 7px rgba(0,0,0,0.25);
    cursor: help;
    transition: transform 0.2s;
}
.badge:hover { transform: scale(1.1); }

#techniquesList { list-style: none; padding: 0; margin-top: 10px;}
#techniquesList li, #currentTechniqueDisplay { 
    font-size: 0.95em; 
    margin-bottom: 6px; 
    padding: 8px 10px; 
    background-color: rgba(255,255,255,0.05);
    border-radius: 6px;
    color: #ccc;
    border-left: 3px solid transparent;
}
#currentTechniqueDisplay.active-technique, /* تم تعديل السلكتر */
#techniquesList li.active-technique { /* إذا كنت ستستخدم قائمة كاملة لاحقًا */
    font-weight: bold;
    color: var(--accent-color);
    background-color: rgba(253, 187, 45, 0.15);
    border-left-color: var(--accent-color);
}
html[dir="ltr"] #currentTechniqueDisplay.active-technique,
html[dir="ltr"] #techniquesList li.active-technique {
    border-left-color: transparent;
    border-right: 3px solid var(--accent-color);
}


/* --- عناصر التحكم الجانبية --- */
.side-controls {
    position: fixed; top: 50%; right: 15px; transform: translateY(-50%);
    display: flex; flex-direction: column; align-items: center; gap: 18px;
    width: var(--nav-width); z-index: 200;
}
html[dir="ltr"] .side-controls { right: auto; left: 15px; }

.navigation-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; }
.navigation-buttons button {
    background: linear-gradient(145deg, var(--accent-color), #e8a820); color: #2c1a0b;
    border: none; padding: 12px 0; font-size: 1em; font-family: var(--font-family-arabic);
    font-weight: bold; border-radius: 10px; cursor: pointer;
    transition: all 0.2s; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    width: 100%; display: flex; align-items: center; justify-content: center;
}
.navigation-buttons button i { font-size: 1.1em; }
.navigation-buttons button:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
.navigation-buttons button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; box-shadow: none; }

.progress-bar-container {
    width: calc(100% - 20px); height: 10px; background-color: var(--card-bg);
    border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.25);
}
.progress-bar { height: 100%; width: 0; background: var(--accent-color); border-radius: 5px; transition: width 0.5s ease-in-out; }

/* --- لوحة الصدارة --- */
#leaderboardTable {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 20px;
}
#leaderboardTable th, #leaderboardTable td {
    padding: 12px 15px;
    text-align: right;
    background-color: rgba(255,255,255,0.05);
    vertical-align: middle;
}
#leaderboardTable th {
    background: linear-gradient(45deg, var(--accent-color), #f7b733);
    color: #2c1a0b;
    font-weight: bold;
    font-size: 1.1em;
}
#leaderboardTable tr:nth-child(even) td { background-color: rgba(255,255,255,0.02); }
#leaderboardTable tr td:first-child, #leaderboardTable tr th:first-child { border-radius: 0 var(--border-radius) var(--border-radius) 0; }
#leaderboardTable tr td:last-child, #leaderboardTable tr th:last-child { border-radius: var(--border-radius) 0 0 var(--border-radius); }
html[dir="ltr"] #leaderboardTable tr td:first-child, html[dir="ltr"] #leaderboardTable tr th:first-child { border-radius: var(--border-radius) 0 0 var(--border-radius); }
html[dir="ltr"] #leaderboardTable tr td:last-child, html[dir="ltr"] #leaderboardTable tr th:last-child { border-radius: 0 var(--border-radius) var(--border-radius) 0; }
#leaderboardTable tr:hover td { background-color: rgba(var(--accent-color-rgb, 253,187,45),0.1); }


/* --- المودال --- */
.modal {
    position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.8); /* أغمق قليلاً */
    display: none; /* يبدأ مخفياً */
    align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}
.modal-content { /* .card-style-content يطبق عليه هذا أيضًا */
    width: 90%; max-width: 650px;
    position: relative;
    animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid var(--accent-color);
}
@keyframes zoomIn { from {transform: scale(0.7); opacity: 0;} to {transform: scale(1); opacity: 1;} }
.close-btn {
    position: absolute; top: 10px; left: 15px;
    font-size: 2.2em; font-weight: bold; cursor: pointer;
    color: #aaa; transition: color 0.2s;
}
html[dir="ltr"] .close-btn { left: auto; right: 15px; }
.close-btn:hover { color: var(--danger-color); transform: scale(1.1); }


/* --- التذييل --- */
.footer-credits { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(15, 12, 41, 0.9); backdrop-filter: blur(5px); color: #aaa; text-align: center; padding: 10px 0; font-size: 0.9em; z-index: 1000; border-top: 1px solid rgba(253, 187, 45, 0.25); }
.footer-credits p { margin: 2px 0; }

/* --- استجابة للشاشات --- */
@media (max-width: 992px) {
    .sidebar-game-info { display: none; }
    body { padding-right: var(--nav-width); padding-left: 10px; }
    html[dir="ltr"] body { padding-left: var(--nav-width); padding-right: 10px; }
    .presentation-container { width: calc(100% - var(--nav-width) - 20px); }
}

@media (max-width: 768px) {
    body { padding-right: 0; padding-left: 0; padding-bottom: 120px; /* مساحة أكبر للأزرار والتذييل */ }
    .presentation-container, #gamePage { width: 95%; height: auto; min-height: 70vh; margin: 15px auto; flex-direction: column; }
    .game-main-content { order: 1; } /* المحتوى الرئيسي أولاً */
    .side-controls {
        position: relative; top: auto; right: auto; left: auto; transform: none;
        flex-direction: row; justify-content: space-between; width: 95%; margin: 20px auto; order: 2;
        background-color: var(--card-bg); padding: 10px; border-radius: var(--border-radius);
    }
    .navigation-buttons { flex-direction: row; width: auto; gap: 15px; }
    .navigation-buttons button { padding: 10px 18px; width: auto; }
    .progress-bar-container { width: 40%; height: 12px; margin-top: 0; }
    .footer-credits { font-size: 0.8em; padding: 8px 0; }
    .modal-content { width: 90%; }
    #loginPage, #leaderboardPage { width: 90%; padding: 20px; }
}

    </style>
</head>
<body>
    <!-- محتوى HTML و JavaScript كما هو في الرد السابق الذي يحتوي على اللعبة كاملة مع التحديات المدمجة -->
    <!-- تأكد من أن أسماء الـ IDs متطابقة بين HTML و JavaScript -->

    <!-- Login Page (index.html content - to be shown first) -->
    <div id="loginPage" class="main-container landing-page" style="max-width: 600px; margin-top: 5vh;">
        <header>
            <i class="fas fa-brain title-icon"></i>
            <h1>لعبة سيد التلقين</h1>
            <p class="subtitle">أتقن فن صياغة التلقينات التعليمية الفعالة!</p>
        </header>
        <section id="loginSection" class="card-style-content">
            <h2><i class="fas fa-user-circle"></i> تسجيل الدخول / اسم اللاعب</h2>
            <input type="text" id="username" placeholder="ادخل اسم المستخدم الخاص بك" aria-label="اسم المستخدم">
            <button id="startGameBtn" class="btn btn-primary"><i class="fas fa-play-circle"></i> ابدأ المغامرة!</button>
        </section>
        <nav class="main-nav" style="margin-top: 20px; display:flex; justify-content:center; gap:15px;">
            <button id="howToPlayBtn" class="btn btn-secondary"><i class="fas fa-question-circle"></i> كيف ألعب؟</button>
            <button id="leaderboardLinkBtn" class="btn btn-secondary"><i class="fas fa-trophy"></i> لوحة الصدارة</button>
        </nav>
    </div>

    <!-- Game Page (game.html content - initially hidden) -->
    <div id="gamePage" class="presentation-container" style="display: none;">
        <!-- الشريط الجانبي لمعلومات اللعبة -->
        <div id="gameSidebar" class="sidebar-game-info">
            <h4><i class="fas fa-medal"></i> شاراتك المكتسبة</h4>
            <div id="badgesEarned" class="badges-grid"></div>
            <hr style="margin: 15px 0; border-color: rgba(255,255,255,0.1);">
            <h4><i class="fas fa-book-open"></i> التقنية الحالية</h4>
            <ul id="techniquesList">
                <li id="currentTechniqueDisplay" class="active-technique"></li>
            </ul>
        </div>

        <!-- المحتوى الرئيسي للعبة -->
        <div class="game-main-content">
            <header class="game-header">
                <div class="player-info">
                    <span id="playerNameDisplay"><i class="fas fa-user"></i> اللاعب: <span class="value"></span></span>
                    <span id="playerScoreDisplay"><i class="fas fa-star"></i> النقاط: <span class="value">0</span></span>
                </div>
                <div class="level-info">
                    <h3><i class="fas fa-flag-checkered"></i> المستوى <span id="currentLevelDisplay">1</span>: <span id="levelNameDisplay">...</span></h3>
                </div>
                <button id="exitGameBtn" class="btn btn-danger btn-small"><i class="fas fa-times-circle"></i> خروج</button>
            </header>

            <div class="game-content-area">
                <div id="challengeDisplay" class="card-style-content">
                    <div class="mentor-speech bubble hidden">
                        <p id="mentorText"></p>
                    </div>
                    <h2 id="challengeTitle"><i class="fas fa-tasks"></i> ...</h2>
                    <p id="challengeDescription" class="challenge-description">...</p>
                    
                    <div class="prompt-input-area">
                        <label for="promptInput">اكتب تلقينك هنا:</label>
                        <textarea id="promptInput" rows="7" placeholder="مثال: تصرف كمعلم علوم خبير في تبسيط المفاهيم..."></textarea>
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <button id="submitPromptBtn" class="btn btn-primary"><i class="fas fa-paper-plane"></i> إرسال التلقين</button>
                            <button id="hintBtn" class="btn btn-warning btn-small"><i class="fas fa-lightbulb"></i> تلميح (<span id="hintsRemaining">3</span>)</button>
                        </div>
                    </div>
                    <div id="feedbackArea" class="feedback hidden">
                        <h4><i class="fas fa-comment-alt"></i> تقييم التلقين:</h4>
                        <p id="feedbackText"></p>
                        <p id="pointsAwarded"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Page (leaderboard.html content - initially hidden) -->
    <div id="leaderboardPage" class="main-container leaderboard-page" style="display: none; max-width: 800px; margin-top: 5vh;">
        <header style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h1><i class="fas fa-trophy"></i> لوحة الصدارة</h1>
            <button id="backToMainFromLeaderboard" class="btn btn-secondary btn-small"><i class="fas fa-arrow-left"></i> العودة</button>
        </header>
        <div class="card-style-content" style="padding-top: 0;">
            <table id="leaderboardTable">
                <thead>
                    <tr>
                        <th>الترتيب</th>
                        <th><i class="fas fa-user"></i> اسم اللاعب</th>
                        <th><i class="fas fa-star"></i> النقاط</th>
                        <th><i class="fas fa-medal"></i> الشارات</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- How to Play Modal (initially hidden) -->
    <div id="howToPlayModal" class="modal">
        <div class="modal-content card-style-content">
            <span id="closeHowToPlayModal" class="close-btn">×</span>
            <h2><i class="fas fa-info-circle"></i> طريقة اللعب</h2>
            <p>في "سيد التلقين"، ستواجه تحديات لصياغة تلقينات تعليمية باستخدام تقنيات مختلفة. كلما كانت تلقيناتك أفضل، حصلت على نقاط أكثر وشارات مميزة. تعلم، تدرب، وتصدر لوحة الأبطال!</p>
            <p>استخدم زر "تلميح" إذا واجهت صعوبة، وحاول تطبيق التقنية المطلوبة في كل تحدٍ.</p>
        </div>
    </div>

    <div class="side-controls">
        <div class="navigation-buttons">
            <button id="nextChallengeBtn" title="التحدي التالي"><i class="fas fa-arrow-up"></i></button>
            <button id="prevChallengeBtn" title="التحدي السابق"><i class="fas fa-arrow-down"></i></button>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar"></div>
        </div>
    </div>

    <div class="footer-credits">
        <p>تصميم: إسلام محمد</p>
        <p>eslam.mohamed@nagwa.com</p>
    </div>

    <script>
        // JavaScript code (game_logic.js + challenges array + page navigation logic)
        // ... (الصق كود JavaScript الكامل من الرد السابق هنا، بما في ذلك مصفوفة gameChallenges المكتملة ومنطق اللعبة) ...
        // game_data.js (محتوى التحديات)
    const gameChallenges = [
        // --- القسم الأول: تقنيات التلقين الأساسية وتحديد السياق ---
        {
            level: 1, levelName: "أساسيات السياق", id: "challenge_role_prompting_1", title: "خبير التاريخ",
            description: "اطلب من النموذج أن يتصرف كـ'مؤرخ متخصص في تاريخ مصر القديمة وخبير في تبسيط المعلومات لطلاب المرحلة الإعدادية'، وأن يشرح نظام الحكم والإدارة في الدولة المصرية القديمة خلال عصر الدولة الوسطى.",
            technique: "التلقين بالنماذج (Role Prompting)",
            keywordsForEvaluation: ["تصرف كـ", "مؤرخ متخصص", "تاريخ مصر القديمة", "تبسيط المعلومات", "نظام الحكم والإدارة", "الدولة الوسطى"], points: 20,
            hint: "حدد بوضوح دور الخبير والجمهور المستهدف والمهمة المطلوبة.",
            badgeAwarded: { id: "roleExpertBadge", name: "خبير الأدوار", icon: "fas fa-user-tie" }
        },
        {
            level: 1, levelName: "أساسيات السياق", id: "challenge_persona_prompting_1", title: "طالب حالم",
            description: "اطلب من النموذج أن يتقمص شخصية 'طالب في الصف الثاني الإعدادي يشعر بالحنين إلى أيام الطفولة وبراءتها'، وأن يكتب فقرة يعبر فيها عن مشاعره تجاه هذه الفترة ويصف أهم ذكرياته.",
            technique: "التلقين الافتراضي (Persona-based)",
            keywordsForEvaluation: ["أنت طالب", "الصف الثاني الإعدادي", "حنين", "طفولة", "مشاعرك", "ذكريات"], points: 20,
            hint: "صف الشخصية ومشاعرها والمطلوب منها بوضوح.",
            badgeAwarded: { id: "personaCreatorBadge", name: "مبدع الشخصيات", icon: "fas fa-theater-masks" }
        },
        // --- القسم الثاني: تقنيات تعزيز الفهم والاستدلال العميق ---
        {
            level: 2, levelName: "تعميق الفهم", id: "challenge_rereading_1", title: "مصمم الأنشطة الدقيق",
            description: "اطلب من النموذج تصميم نشاط تعليمي لطلاب الصف الخامس الابتدائي حول مفهوم 'المساحة والمحيط للمستطيل' يتضمن: تعريفًا مبسطًا، مثالاً محلولاً، تمرينين، ورسمًا توضيحيًا. ثم اطلب منه 'إعادة قراءة هذه المتطلبات' قبل تقديم تصميم النشاط.",
            technique: "إعادة القراءة (RE2)",
            keywordsForEvaluation: ["تصميم نشاط", "المساحة والمحيط", "تعريف مبسط", "مثال محلول", "تمرينين", "رسم توضيحي", "أعد قراءة"], points: 25,
            hint: "اذكر جميع المتطلبات بوضوح ثم استخدم عبارة 'أعد قراءة هذه المتطلبات'.",
            badgeAwarded: { id: "reReaderBadge", name: "القارئ المتمعن", icon: "fas fa-book-open-reader" }
        },
        {
            level: 2, levelName: "تعميق الفهم", id: "challenge_rar_1", title: "الموضح الخبير",
            description: "لديك طلب غامض: 'اكتب عن تأثير التغير المناخي على الزراعة في مصر لطلاب الإعدادي'. اطلب من النموذج أن 'يعيد صياغة ويوسع هذا الطلب'، موضحًا الجوانب التي يجب التركيز عليها ومستوى التفصيل المناسب لأعمارهم، ثم أن يكتب فقرتين بناءً على إعادة الصياغة.",
            technique: "إعادة الصياغة والاستجابة (RaR)",
            keywordsForEvaluation: ["أعد صياغة وتوسيع", "تأثير التغير المناخي", "الزراعة في مصر", "الجوانب التي يجب التركيز", "مستوى التفصيل"], points: 25,
            hint: "اطلب من النموذج توضيح فهمه للمهمة قبل البدء في تنفيذها.",
            badgeAwarded: { id: "rephraserBadge", name: "المعيد المتمكن", icon: "fas fa-retweet" }
        },
        {
            level: 2, levelName: "تعميق الفهم", id: "challenge_s2a_1", title: "الملخص المركز",
            description: "قدم للنموذج النص التالي (مع معلومات مشتتة): 'لخص النقاش التالي الذي دار بين الطلاب حول أسباب ثورة 1919 في مصر. بدأ النقاش بتعليق من أحمد حول دور سعد زغلول، ثم تحدثت سارة عن الأوضاع الاقتصادية، لكن قاطعها كريم ليتحدث عن فيلم وثائقي شاهده مؤخرًا عن تلك الفترة وكيف كان التصوير رائعًا.' ثم اطلب منه 'استخراج فقط الأجزاء التي تناقش الأسباب المباشرة لثورة 1919 وتجاهل التعليقات الجانبية، ثم تلخيص هذه الأجزاء'.",
            technique: "انتباه النظام 2 (S2A)",
            keywordsForEvaluation: ["استخرج فقط الأجزاء", "الأسباب المباشرة", "ثورة 1919", "تجاهل التعليقات الجانبية", "تلخيص"], points: 25,
            hint: "اطلب من النموذج تنقيح المدخلات والتركيز على المعلومات الجوهرية.",
            badgeAwarded: { id: "s2aFilterBadge", name: "مرشح S2A", icon: "fas fa-filter-circle-dollar" }
        },
        {
            level: 3, levelName: "الاستدلال المتقدم", id: "challenge_simtom_1", title: "محلل الشخصيات",
            description: "قدم السياق التالي: 'كان الأرنب السريع يسخر دائمًا من السلحفاة البطيئة. نام الأرنب في منتصف الطريق ظنًا منه أن السلحفاة لن تسبقه.' اطلب من النموذج: 'أنت الأرنب في القصة. ما هي أفكارك ومعتقداتك في هذه اللحظة؟' ثم اطلب منه: 'بناءً على ما تعرفه وتعتقده (كأرنب)، هل تتوقع أن تفوز السلحفاة بالسباق؟ ولماذا؟'",
            technique: "محاكاة نظرية العقل (SimToM)",
            keywordsForEvaluation: ["أنت الأرنب", "أفكارك ومعتقداتك", "بناءً على ما تعرفه وتعتقده", "هل تتوقع"], points: 30,
            hint: "اجعل النموذج يفكر من منظور شخصية أخرى بمعرفتها المحدودة.",
            badgeAwarded: { id: "simTomBadge", name: "محاكي العقول", icon: "fas fa-users-viewfinder" }
        },
        {
            level: 3, levelName: "الاستدلال المتقدم", id: "challenge_reflection_1", title: "الناقد البناء",
            description: "اطلب من النموذج أولاً 'شرح مفهوم الجاذبية الأرضية لطلاب الصف السادس'. بعد أن يقدم إجابته (افترض أنه قدمها)، اطلب منه: 'راجع الشرح الذي قدمته. هل استخدمت أمثلة كافية؟ هل اللغة بسيطة؟ هل هناك مصطلحات تحتاج تبسيط؟ قدم نسخة منقحة'.",
            technique: "التلقين الانعكاسي",
            keywordsForEvaluation: ["راجع الشرح", "أمثلة كافية", "لغة بسيطة", "تبسيط المصطلحات", "نسخة منقحة"], points: 30,
            hint: "اطلب من النموذج تقييم وتحسين مخرجاته الأولية بناءً على معايير.",
            badgeAwarded: { id: "reflectionPro", name: "المراجع الخبير", icon: "fas fa-rotate-left" }
        },
        {
            level: 3, levelName: "الاستدلال المتقدم", id: "challenge_maieutic_1", title: "المحاور السقراطي",
            description: "اطلب من النموذج شرح ظاهرة 'قوس قزح' لطلاب المرحلة الابتدائية، وذلك من خلال الإجابة على سلسلة من الأسئلة التوجيهية التي تقدمها له خطوة بخطوة، مثل: 1. متى نرى قوس قزح؟ 2. ما مصدر الضوء؟ 3. مم يتكون ضوء الشمس؟ ...إلخ، حتى يصل إلى شرح كامل.",
            technique: "التلقين المايوتيكي",
            keywordsForEvaluation: ["سلسلة من الأسئلة", "خطوة بخطوة", "فرضية:", "تفسير:", "بناءً على هذه الخطوات"], points: 30,
            hint: "قدّم أسئلة متسلسلة تبني الفهم تدريجيًا.",
            badgeAwarded: { id: "maieuticMaster", name: "المحاور السقراطي", icon: "fas fa-sitemap" }
        },
        // --- القسم الثالث: تقنيات التلقين التفاعلية والتكيفية ---
        {
            level: 4, levelName: "التفاعل والتكيف", id: "challenge_active_prompting_1", title: "مكتشف الصعوبات",
            description: "تخيل أنك تريد تحديد المفاهيم الصعبة في وحدة 'الكسور' لطلاب الصف الرابع. صغ تلقينًا يطلب من النموذج (افتراضيًا) تحليل مجموعة من إجاباته السابقة على أسئلة الكسور، وتحديد الأسئلة الثلاثة التي أظهر فيها أكبر قدر من 'عدم اليقين' أو التناقض، ثم يقترح كيف يمكن للمطور شرح هذه المفاهيم الصعبة.",
            technique: "التلقين النشط",
            keywordsForEvaluation: ["تحليل إجابات سابقة", "عدم اليقين", "تناقض", "المفاهيم الصعبة", "شرح هذه المفاهيم"], points: 35,
            hint: "ركز على فكرة استخدام 'عدم يقين' النموذج لتوجيه جهود التحسين.",
            badgeAwarded: { id: "activeLearnerBadge", name: "المتعلم النشط", icon: "fas fa-bolt" }
        },
        {
            level: 4, levelName: "التفاعل والتكيف", id: "challenge_clarification_prompting_1", title: "طالب التوضيح",
            description: "لديك طلب عام للنموذج: 'أريد أفكارًا لمشاريع بحثية عن البيئة لطلاب الإعدادي'. صغ تلقينًا يوجه النموذج (إذا كان مدربًا على ذلك) ليطرح أسئلة توضيحية قبل تقديم الأفكار، مثل سؤاله عن الموضوعات البيئية المحددة، نوع المشاريع المفضلة، أو المدة الزمنية.",
            technique: "التلقين بالتوضيح",
            keywordsForEvaluation: ["هل يمكنك توضيح:", "موضوعات بيئية محددة", "نوع المشاريع", "مدة زمنية"], points: 25,
            hint: "صغ طلبًا أوليًا غامضًا، ثم اطلب من النموذج أن يستوضح قبل الإجابة.",
            badgeAwarded: { id: "clarifierBadge", name: "المستوضح البارع", icon: "fas fa-question" }
        },
        // --- القسم الرابع: تقنيات التلقين المتقدمة والمنهجية ---
        {
            level: 5, levelName: "المنهجيات المتقدمة", id: "challenge_progressive_prompting_1", title: "البناء التدريجي",
            description: "اطلب من النموذج إنشاء شرح مبسط لـ 'الجهاز الهضمي' للصف الخامس. ابدأ بتلقين يطلب المقدمة والأعضاء الرئيسية. ثم، في تلقين ثانٍ (افتراضي)، اطلب منه التركيز على وظيفة الفم والمريء بناءً على الشرح السابق.",
            technique: "التلقين التدريجي",
            keywordsForEvaluation: ["اشرح بأسلوب مبسط", "الأعضاء الرئيسية", "بناءً على الشرح السابق", "ركز الآن على"], points: 30,
            hint: "قسم المهمة إلى خطوات، واجعل كل خطوة لاحقة تبني على سابقتها.",
            badgeAwarded: { id: "progressiveBuilder", name: "البنّاء التدريجي", icon: "fas fa-stairs" }
        },
        {
            level: 5, levelName: "المنهجيات المتقدمة", id: "challenge_contrastive_prompting_1", title: "المقارن الخبير",
            description: "اطلب من النموذج شرح الفرق بين 'التاء المربوطة والتاء المفتوحة'. اطلب منه تقديم مثال صحيح لكل منهما، ثم مثال خاطئ شائع قد يقع فيه الطلاب، مع توضيح سبب صحة الصحيح وخطأ الخاطئ.",
            technique: "التلقين التبايني",
            keywordsForEvaluation: ["اشرح الفرق", "مثالاً صحيحًا", "مثالاً خاطئًا شائعًا", "وضح لماذا", "التمييز بينهما"], points: 30,
            hint: "اطلب أمثلة إيجابية وسلبية مع شرح التباين بينها.",
            badgeAwarded: { id: "contrastiveThinker", name: "المفكر التبايني", icon: "fas fa-code-compare" }
        },
        {
            level: 5, levelName: "المنهجيات المتقدمة", id: "challenge_emotion_prompting_1", title: "الكاتب الملهم",
            description: "اطلب من النموذج كتابة مقدمة لوحدة تعليمية عن 'وطننا الغالي مصر' لطلاب المرحلة الإعدادية. استخدم عبارات مثل 'يا مبدع الكلمات'، 'يجب أن تشعل في قلوبهم نيران الانتماء'، 'أظهر لنا براعتك' لتحفيزه عاطفياً.",
            technique: "التلقين العاطفي",
            keywordsForEvaluation: ["يا مبدع الكلمات", "تفيض حباً وشوقاً", "تشعل في قلوبهم", "براعتك", "أسر القلوب"], points: 25,
            hint: "استخدم لغة مشحونة بالعاطفة لتحفيز النموذج.",
            badgeAwarded: { id: "emotionEvoker", name: "مثير المشاعر", icon: "fas fa-face-grin-hearts" }
        },
        // --- القسم الخامس: تقنيات التلقين المعتمدة على البيانات والأدوات ---
        {
            level: 6, levelName: "أدوات وبيانات", id: "challenge_rag_1", title: "الباحث المطلع",
            description: "اطلب من النموذج إعداد موجز لطلاب الثانوية العامة حول 'أهم ثلاثة مشروعات قومية جديدة في مصر تم إطلاقها خلال الـ 12 شهرًا الماضية'. اذكر في تلقينك أنه يجب عليه (افتراضيًا) 'استخدام قاعدة البيانات المتاحة التي تحتوي على أحدث البيانات الصحفية والتقارير الحكومية'.",
            technique: "التوليد المعزز بالاسترجاع (RAG)",
            keywordsForEvaluation: ["أحدث المشروعات", "خلال الـ 12 شهرًا الماضية", "استخدم قاعدة البيانات المتاحة", "بيانات صحفية", "تقارير حكومية"], points: 35,
            hint: "اطلب معلومات حديثة جدًا واذكر (افتراضيًا) ضرورة استخدام مصدر بيانات خارجي.",
            badgeAwarded: { id: "ragResearcher", name: "باحث RAG", icon: "fas fa-cloud-download-alt" }
        },
        {
            level: 6, levelName: "أدوات وبيانات", id: "challenge_art_ape_1", title: "مهندس التلقين الآلي",
            description: "اطلب من نموذج (لنفترض أنه APE) أن 'يولد 4 تلقينات مختلفة يمكن تقديمها لنموذج لغوي آخر بهدف إنشاء أسئلة مناقشة عميقة ومبتكرة حول الجوانب الإيجابية والسلبية لسياسات محمد علي باشا'.",
            technique: "التلقين التلقائي باستخدام الأدوات (APE)",
            keywordsForEvaluation: ["قم بتوليد 4 تلقينات مختلفة", "نموذج لغوي آخر", "أسئلة مناقشة عميقة", "تحليل نقدي"], points: 30,
            hint: "اطلب من النموذج إنشاء تلقينات بدلاً من إنشاء المحتوى مباشرة.",
            badgeAwarded: { id: "autoPrompter", name: "مهندس التلقين الآلي", icon: "fas fa-tools" }
        },
        {
            level: 6, levelName: "أدوات وبيانات", id: "challenge_soft_prompting_1", title: "المخصص الدقيق",
            description: "تخيل أن لديك 'تلقين ناعم' تم تدريبه مسبقًا اسمه 'تلقين_شرح_رياض_أطفال'. صغ تلقينًا (للنظام/المطور) يطلب من النموذج 'باستخدام تلقين_شرح_رياض_أطفال، اشرح مفهوم دورة الماء في الطبيعة' بأسلوب قصصي ومبسط جدًا يناسب أطفال مرحلة رياض الأطفال.",
            technique: "التلقين الناعم (Soft Prompting)",
            keywordsForEvaluation: ["باستخدام 'تلقين_شرح_رياض_أطفال'", "اشرح مفهوم", "دورة الماء في الطبيعة", "أسلوب قصصي ومبسط"], points: 25,
            hint: "صغ الطلب كما لو كنت تستدعي تخصصًا دقيقًا للنموذج عبر تلقين ناعم محدد مسبقًا.",
            badgeAwarded: { id: "softTuner", name: "موالف التلقين الناعم", icon: "fas fa-wave-square" }
        }
    ];
    
    // JavaScript code (game_logic.js from previous response)
    // ... (الصق هنا كود JavaScript الذي يبدأ بـ `let currentPlayer = ...` وينتهي بـ `showLoginPage();`) ...
    // (تأكد من أن اسم المصفوفة المستخدم في game_logic.js هو gameChallenges)
    document.addEventListener('DOMContentLoaded', () => {
        const loginPage = document.getElementById('loginPage');
        const gamePage = document.getElementById('gamePage');
        const gameSidebar = document.getElementById('gameSidebar');
        const leaderboardPage = document.getElementById('leaderboardPage');
        
        const startGameBtn = document.getElementById('startGameBtn');
        const usernameInput = document.getElementById('username');
        const howToPlayBtn = document.getElementById('howToPlayBtn');
        const leaderboardLinkBtn = document.getElementById('leaderboardLinkBtn');
        const howToPlayModal = document.getElementById('howToPlayModal');
        const closeHowToPlayModal = document.getElementById('closeHowToPlayModal');
        const backToMainFromLeaderboard = document.getElementById('backToMainFromLeaderboard');

        const playerNameDisplay = document.getElementById('playerNameDisplay')?.querySelector('.value');
        const playerScoreDisplay = document.getElementById('playerScoreDisplay')?.querySelector('.value');
        const currentLevelDisplayEl = document.getElementById('currentLevelDisplay'); // تم تغيير الاسم قليلاً
        const levelNameDisplayEl = document.getElementById('levelNameDisplay'); // تم تغيير الاسم قليلاً
        const exitGameBtn = document.getElementById('exitGameBtn');

        const challengeDisplayArea = document.getElementById('challengeDisplay');
        const mentorTextEl = document.getElementById('mentorText');
        const mentorSpeechBubble = document.querySelector('.mentor-speech');
        const challengeTitleEl = document.getElementById('challengeTitle');
        const challengeDescriptionEl = document.getElementById('challengeDescription');
        const promptInputEl = document.getElementById('promptInput');
        const submitPromptBtn = document.getElementById('submitPromptBtn');
        const hintBtn = document.getElementById('hintBtn');
        const hintsRemainingEl = document.getElementById('hintsRemaining');
        const feedbackAreaEl = document.getElementById('feedbackArea');
        const feedbackTextEl = document.getElementById('feedbackText');
        const pointsAwardedEl = document.getElementById('pointsAwarded');

        const badgesEarnedEl = document.getElementById('badgesEarned');
        const currentTechniqueDisplayEl = document.getElementById('currentTechniqueDisplay');

        const nextChallengeBtn = document.getElementById('nextChallengeBtn');
        const prevChallengeBtn = document.getElementById('prevChallengeBtn');
        const progressBar = document.querySelector('.side-controls .progress-bar');


        let currentPlayer = {
            name: localStorage.getItem('promptMasterUsername') || "زائر",
            score: parseInt(localStorage.getItem('promptMasterUserScore')) || 0,
            badges: JSON.parse(localStorage.getItem('promptMasterUserBadges')) || [],
            hints: 3,
            currentChallengeIndex: parseInt(localStorage.getItem('promptMasterChallengeIndex')) || 0
        };

        function saveGameState() {
            localStorage.setItem('promptMasterUsername', currentPlayer.name);
            localStorage.setItem('promptMasterUserScore', currentPlayer.score);
            localStorage.setItem('promptMasterUserBadges', JSON.stringify(currentPlayer.badges));
            localStorage.setItem('promptMasterChallengeIndex', currentPlayer.currentChallengeIndex);
            localStorage.setItem('promptMasterUserHints', currentPlayer.hints);
        }

        function updatePlayerStatsDisplay() {
            if (playerNameDisplay) playerNameDisplay.textContent = currentPlayer.name;
            if (playerScoreDisplay) playerScoreDisplay.textContent = currentPlayer.score;
            if (hintsRemainingEl) hintsRemainingEl.textContent = currentPlayer.hints;
            updateBadgesDisplay();
            saveGameState();
        }

        function updateBadgesDisplay() {
            if (!badgesEarnedEl) return;
            badgesEarnedEl.innerHTML = "";
            const uniqueBadges = currentPlayer.badges.filter((badge, index, self) =>
                badge && badge.id && index === self.findIndex((b) => b && b.id === badge.id)
            );

            uniqueBadges.forEach(badge => {
                const badgeEl = document.createElement('div');
                badgeEl.className = 'badge';
                badgeEl.title = badge.name;
                badgeEl.innerHTML = `<i class="${badge.icon || 'fas fa-medal'}"></i>`;
                badgesEarnedEl.appendChild(badgeEl);
            });
        }

        function showMentorMessage(message, duration = 4000) {
            if (mentorTextEl && mentorSpeechBubble) {
                mentorTextEl.textContent = message;
                mentorSpeechBubble.classList.remove('hidden');
                mentorSpeechBubble.style.display = 'block'; // Ensure it's block
                setTimeout(() => {
                    mentorSpeechBubble.classList.add('hidden');
                    mentorSpeechBubble.style.display = 'none';
                }, duration);
            }
        }
        
        function updateProgressBar() {
            if (progressBar && gameChallenges.length > 0) {
                const progressPercentage = ((currentPlayer.currentChallengeIndex + 1) / gameChallenges.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
            }
        }

        function loadChallenge(challengeIndex) {
            if (challengeIndex >= gameChallenges.length) {
                challengeTitleEl.innerHTML = `<i class="fas fa-trophy"></i> أحسنت! لقد أكملت كل التحديات!`;
                challengeDescriptionEl.innerHTML = `مجموع نقاطك النهائية: <strong>${currentPlayer.score}</strong>.`;
                promptInputEl.style.display = 'none';
                submitPromptBtn.style.display = 'none';
                hintBtn.style.display = 'none';
                document.querySelector('.prompt-input-area label').style.display = 'none';

                nextChallengeBtn.disabled = true; 
                prevChallengeBtn.disabled = challengeIndex === 0;
                showMentorMessage("لقد وصلت إلى نهاية الرحلة يا بطل التلقين! تفقد لوحة الصدارة لترى ترتيبك.", 8000);
                if (currentTechniqueDisplayEl) currentTechniqueDisplayEl.textContent = "لا يوجد";
                updateProgressBar();
                return;
            }
            if (challengeIndex < 0) {
                currentPlayer.currentChallengeIndex = 0;
                loadChallenge(0);
                return;
            }

            const challenge = gameChallenges[challengeIndex];
            currentPlayer.currentChallengeIndex = challengeIndex;

            if (currentLevelDisplayEl) currentLevelDisplayEl.textContent = challenge.level;
            if (levelNameDisplayEl) levelNameDisplayEl.textContent = challenge.levelName;
            if (challengeTitleEl) challengeTitleEl.innerHTML = `<i class="fas fa-tasks"></i> ${challenge.title}`;
            if (challengeDescriptionEl) challengeDescriptionEl.innerHTML = challenge.description;
            if (currentTechniqueDisplayEl) {
                 currentTechniqueDisplayEl.textContent = challenge.technique;
                 currentTechniqueDisplayEl.classList.add('active-technique');
            }

            promptInputEl.value = "";
            promptInputEl.disabled = false;
            promptInputEl.style.display = 'block';
            submitPromptBtn.disabled = false;
            submitPromptBtn.style.display = 'inline-flex';
            hintBtn.disabled = currentPlayer.hints <= 0;
            hintBtn.style.display = 'inline-flex';
             document.querySelector('.prompt-input-area label').style.display = 'block';


            feedbackAreaEl.classList.add('hidden');
            feedbackAreaEl.className = 'feedback hidden';
            pointsAwardedEl.textContent = "";

            if (prevChallengeBtn) prevChallengeBtn.disabled = challengeIndex === 0;
            if (nextChallengeBtn) nextChallengeBtn.disabled = challengeIndex >= gameChallenges.length - 1;
            
            updateProgressBar();
            saveGameState();
        }

        function evaluatePrompt() {
            const userInput = promptInputEl.value.trim();
            if (!userInput) {
                showMentorMessage("لا تنسَ كتابة تلقينك أولاً!");
                return;
            }

            const challenge = gameChallenges[currentPlayer.currentChallengeIndex];
            let scoreForPrompt = 0;
            let feedback = "";
            
            let keywordsFound = 0;
            if (challenge.keywordsForEvaluation && challenge.keywordsForEvaluation.length > 0) {
                challenge.keywordsForEvaluation.forEach(keyword => {
                    if (userInput.toLowerCase().includes(keyword.toLowerCase())) {
                        keywordsFound++;
                    }
                });
            } else {
                keywordsFound = 1; 
            }

            const techniqueMentionedName = challenge.technique.split('(')[0].trim().toLowerCase();
            const userMentionedTechnique = userInput.toLowerCase().includes(techniqueMentionedName);

            if (keywordsFound >= Math.min(2, challenge.keywordsForEvaluation?.length || 1) || userMentionedTechnique) {
                scoreForPrompt = challenge.points;
                feedback = "تلقين ممتاز! يبدو أنك تطبق التقنية بشكل صحيح.";
                feedbackAreaEl.className = 'feedback show success';

                if (challenge.badgeAwarded && !currentPlayer.badges.find(b => b && b.id === challenge.badgeAwarded.id)) {
                    currentPlayer.badges.push(challenge.badgeAwarded);
                    feedback += ` <i class="fas fa-medal"></i> لقد حصلت على شارة: ${challenge.badgeAwarded.name}!`;
                    updateBadgesDisplay();
                }
                
                // لا ينتقل تلقائياً، دع اللاعب ينقر على "التالي"
                 submitPromptBtn.disabled = true; // تعطيل زر الإرسال بعد محاولة ناجحة لهذا التحدي


            } else if (keywordsFound > 0) {
                scoreForPrompt = Math.floor(challenge.points / 3);
                feedback = "محاولة جيدة، لكن حاول التركيز أكثر على متطلبات التحدي وتطبيق التقنية المحددة بشكل أوضح.";
                feedbackAreaEl.className = 'feedback show warning';
            } else {
                scoreForPrompt = 0;
                feedback = "هممم، هذا التلقين لا يبدو أنه يلبي المطلوب. راجع وصف التحدي والتلميح إذا احتجت.";
                feedbackAreaEl.className = 'feedback show error';
            }

            currentPlayer.score += scoreForPrompt;
            updatePlayerStatsDisplay();
            feedbackTextEl.innerHTML = feedback;
            pointsAwardedEl.textContent = scoreForPrompt !== 0 ? `${scoreForPrompt > 0 ? '+' : ''}${scoreForPrompt} نقطة!` : "لا نقاط هذه المرة.";
            feedbackAreaEl.classList.remove('hidden');
        }

        function showHint() {
            if (currentPlayer.currentChallengeIndex >= gameChallenges.length) return;
            if (currentPlayer.hints > 0) {
                const challenge = gameChallenges[currentPlayer.currentChallengeIndex];
                showMentorMessage(`تلميح: ${challenge.hint}`, 7000);
                currentPlayer.hints--;
                updatePlayerStatsDisplay();
                if (currentPlayer.hints <= 0) {
                    hintBtn.disabled = true;
                }
            } else {
                showMentorMessage("لقد استنفدت كل تلميحاتك!");
            }
        }

        function initializeGamePage() {
            currentPlayer.name = localStorage.getItem('promptMasterUsername') || "زائر";
            currentPlayer.score = parseInt(localStorage.getItem('promptMasterUserScore')) || 0;
            currentPlayer.badges = JSON.parse(localStorage.getItem('promptMasterUserBadges')) || [];
            currentPlayer.currentChallengeIndex = parseInt(localStorage.getItem('promptMasterChallengeIndex')) || 0;
            currentPlayer.hints = parseInt(localStorage.getItem('promptMasterUserHints')) || 3; // استعادة التلميحات


            updatePlayerStatsDisplay();
            loadChallenge(currentPlayer.currentChallengeIndex);

            if(submitPromptBtn) submitPromptBtn.addEventListener('click', evaluatePrompt);
            if(hintBtn) hintBtn.addEventListener('click', showHint);
            
            if(exitGameBtn) {
                exitGameBtn.addEventListener('click', () => {
                    saveGameState();
                    showLoginPage();
                });
            }

            if(nextChallengeBtn) {
                nextChallengeBtn.addEventListener('click', () => {
                    if (currentPlayer.currentChallengeIndex < gameChallenges.length -1) {
                         loadChallenge(currentPlayer.currentChallengeIndex + 1);
                    } else if (currentPlayer.currentChallengeIndex === gameChallenges.length -1) {
                        // إذا كان في آخر تحدي متاح (قبل شريحة النهاية)
                        loadChallenge(gameChallenges.length); // عرض شريحة النهاية
                    }
                });
            }
            if(prevChallengeBtn) {
                prevChallengeBtn.addEventListener('click', () => {
                    if (currentPlayer.currentChallengeIndex > 0) {
                         loadChallenge(currentPlayer.currentChallengeIndex - 1);
                    }
                });
            }
        }

        function showLoginPage() {
            loginPage.style.display = 'block';
            gamePage.style.display = 'none';
            gameSidebar.style.display = 'none';
            if (leaderboardPage) leaderboardPage.style.display = 'none';
        }

        function showGamePage() {
            loginPage.style.display = 'none';
            gamePage.style.display = 'flex'; // Use flex as per your layout
            gameSidebar.style.display = 'block';
            if (leaderboardPage) leaderboardPage.style.display = 'none';
            initializeGamePage();
        }

        function showLeaderboardPage() {
            loginPage.style.display = 'none';
            gamePage.style.display = 'none';
            gameSidebar.style.display = 'none';
            if (leaderboardPage) leaderboardPage.style.display = 'block';
            populateLeaderboard();
        }

        if (startGameBtn) {
            startGameBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim();
                if (username) {
                    currentPlayer.name = username;
                    currentPlayer.score = 0;
                    currentPlayer.badges = [];
                    currentPlayer.currentChallengeIndex = 0;
                    currentPlayer.hints = 3;
                    saveGameState();
                    showGamePage();
                } else {
                    alert("الرجاء إدخال اسم المستخدم!");
                }
            });
        }

        if (leaderboardLinkBtn) leaderboardLinkBtn.addEventListener('click', showLeaderboardPage);
        if (backToMainFromLeaderboard) backToMainFromLeaderboard.addEventListener('click', showLoginPage);
        if (howToPlayBtn) howToPlayBtn.addEventListener('click', () => { if (howToPlayModal) howToPlayModal.style.display = 'flex'; });
        if (closeHowToPlayModal) closeHowToPlayModal.addEventListener('click', () => { if (howToPlayModal) howToPlayModal.style.display = 'none'; });
        if (howToPlayModal) {
            window.addEventListener('click', (event) => {
                if (event.target == howToPlayModal) {
                    howToPlayModal.style.display = 'none';
                }
            });
        }

        function populateLeaderboard() {
            const leaderboardTableBody = document.getElementById('leaderboardTable')?.querySelector('tbody');
            if (!leaderboardTableBody) return;

            let allPlayersData = JSON.parse(localStorage.getItem('promptMasterAllPlayers')) || [];
            const existingPlayerIndex = allPlayersData.findIndex(p => p.name === currentPlayer.name);

            if (existingPlayerIndex > -1) {
                if (currentPlayer.score >= allPlayersData[existingPlayerIndex].score) { // تحديث فقط إذا كانت النتيجة أعلى أو مساوية
                    allPlayersData[existingPlayerIndex].score = currentPlayer.score;
                    allPlayersData[existingPlayerIndex].badgesCount = currentPlayer.badges.length;
                }
            } else if (currentPlayer.name !== "زائر" && currentPlayer.score > 0) { // لا تضف الزائر أو من لم يلعب
                 allPlayersData.push({ name: currentPlayer.name, score: currentPlayer.score, badgesCount: currentPlayer.badges.length });
            }
            
            localStorage.setItem('promptMasterAllPlayers', JSON.stringify(allPlayersData));

            allPlayersData.sort((a, b) => {
                if (b.score === a.score) return b.badgesCount - a.badgesCount;
                return b.score - a.score;
            });

            leaderboardTableBody.innerHTML = '';
            allPlayersData.slice(0, 10).forEach((player, index) => {
                const row = leaderboardTableBody.insertRow();
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = player.name;
                row.insertCell().textContent = player.score;
                row.insertCell().textContent = player.badgesCount || 0;
            });
        }
        
        showLoginPage(); // Start with the login page
    });

    </script>
</body>
</html>
